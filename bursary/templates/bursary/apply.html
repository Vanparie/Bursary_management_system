{% extends 'bursary/base.html' %}
{% load form_extras %}

{% block title %}Apply for Bursary{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="mb-4 text-center">üìã Bursary Application Form</h2>

          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- 1. Student Details -->
            <h4 class="mt-4">1. Personal Details</h4>
            {% for field in student_form %}
              <div class="mb-3">
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field|add_class:"form-control" }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
              </div>
            {% endfor %}

            <!-- Disability and Previous Bursary -->
            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input" name="has_disability" id="has_disability">
              <label class="form-check-label" for="has_disability">I have a disability</label>
            </div>
            <div id="disability_details" class="mb-3" style="display: none;">
              <label class="form-label">Please provide details of your disability:</label>
              <textarea class="form-control" name="disability_details" rows="3"></textarea>
            </div>

            <div class="form-check mb-2">
              <input type="checkbox" class="form-check-input" name="received_bursary_before" id="received_bursary_before">
              <label class="form-check-label" for="received_bursary_before">I have received a bursary before</label>
            </div>
            <div id="previous_bursary_details" class="mb-3" style="display: none;">
              <label class="form-label">Please provide details of the previous bursary received:</label>
              <textarea class="form-control" name="previous_bursary_details" rows="3"></textarea>
            </div>

            <!-- 2. Guardian Info -->
            <h4 class="mt-4">2. Parent/Guardian Information</h4>
            {% for field in guardian_form %}
              <div class="mb-3">
                <label class="form-label">{{ field.label }}</label>
                {{ field|add_class:"form-control" }}
                {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
              </div>
            {% endfor %}

            <!-- 3. Application Info -->
            <h4 class="mt-4">3. Application Details</h4>
            <div class="mb-3">
              <label class="form-label">Constituency</label>
              <input type="text" class="form-control" value="{{ student.constituency.name }}" readonly>
            </div>
            {% for field in application_form %}
              {% if field.name != 'constituency' %}
                <div class="mb-3">
                  <label class="form-label">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- 4. Sibling Info -->
            <h4 class="mt-4">4. Siblings in School</h4>
            <button type="button" class="btn btn-outline-primary mb-3" id="add-sibling-btn">‚ûï Add Sibling</button>
            {{ sibling_formset.management_form }}
            <div id="siblings-container">
              {% for form in sibling_formset %}
                <div class="border p-3 mb-3 rounded shadow-sm bg-light sibling-item position-relative">
                  <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
                  {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                      <div class="mb-2">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}

                  {{ form.DELETE|add_class:"d-none" }}
                </div>
              {% endfor %}
            </div>

            <!-- 5. Supporting Documents -->
            <h4 class="mt-4">5. Supporting Documents</h4>
            <p>Please upload the following documents:</p>
            <ul>
              <li>Admission Letter</li>
              <li>School Fee Structure</li>
              <li>Copy of ID/Birth Certificate</li>
              <li>KCPE/KCSE/Previous Results</li>
              <li>Death Certificate (if orphan)</li>
              <li>Disability Certificate (if applicable)</li>
            </ul>

            {{ document_formset.management_form }}
            <div id="documents-container">
              {% for form in document_formset %}
                <div class="border p-3 mb-3 rounded shadow-sm bg-light form-item position-relative">
                  <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
                  {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                      <div class="mb-2">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                  {{ form.DELETE|add_class:"d-none" }}
                </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-secondary mb-3" id="add-document-btn">‚ûï Add Another Document</button>

            <!-- Submit Button -->
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary px-5">Submit Application</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Hidden Templates for JS cloning -->
<div id="empty-sibling-form" class="d-none">
  <div class="border p-3 mb-3 rounded shadow-sm bg-light sibling-item position-relative">
    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
    __FORM__
  </div>
</div>

<div id="empty-document-form" class="d-none">
  <div class="border p-3 mb-3 rounded shadow-sm bg-light form-item position-relative">
    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
    __FORM__
  </div>
</div>

<!-- JS Section -->
<script>
  document.getElementById('has_disability').addEventListener('change', function() {
    document.getElementById('disability_details').style.display = this.checked ? 'block' : 'none';
  });
  document.getElementById('received_bursary_before').addEventListener('change', function() {
    document.getElementById('previous_bursary_details').style.display = this.checked ? 'block' : 'none';
  });

  function markForDelete(button) {
    const form = button.closest('.form-item, .sibling-item');
    form.querySelector('input[type=checkbox][name$="-DELETE"]').checked = true;
    form.style.display = 'none';
  }

  // Dynamic siblings addition
  document.getElementById('add-sibling-btn').addEventListener('click', function () {
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const newIdx = parseInt(totalForms.value);
    const template = document.getElementById('empty-sibling-form').innerHTML.replace('__FORM__', sibling_formset_empty_form.replace(/__prefix__/g, newIdx));
    document.getElementById('siblings-container').insertAdjacentHTML('beforeend', template);
    totalForms.value = newIdx + 1;
  });

  // Dynamic supporting documents addition
  document.getElementById('add-document-btn').addEventListener('click', function () {
    const totalForms = document.getElementById('id_documents_set-TOTAL_FORMS');
    const newIdx = parseInt(totalForms.value);
    const template = document.getElementById('empty-document-form').innerHTML.replace('__FORM__', document_formset_empty_form.replace(/__prefix__/g, newIdx));
    document.getElementById('documents-container').insertAdjacentHTML('beforeend', template);
    totalForms.value = newIdx + 1;
  });

  // Make Django's empty form HTML accessible to JS
  const sibling_formset_empty_form = `{{ sibling_formset.empty_form.as_p|escapejs }}`;
  const document_formset_empty_form = `{{ document_formset.empty_form.as_p|escapejs }}`;
</script>

{% if application_deadline %}
  <div class="deadline-ticker-wrapper mt-4">
    <div class="deadline-ticker">
      ‚è≥ Deadline: {{ application_deadline|date:"F j, Y" }} ‚Äì Don‚Äôt wait until the last minute!
    </div>
  </div>
{% endif %}
{% endblock %}









