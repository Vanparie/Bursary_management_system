{% extends 'bursary/base.html' %}
{% load form_extras %}

{% block title %}Apply for Bursary{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="mb-4 text-center">📋 Bursary Application Form</h2>

          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- 1. Student Details -->
            <h4 class="mt-4">1. Personal Details</h4>
            {% for field in student_form %}
              {% if field.name not in 'has_disability previous_bursary disability_details previous_bursary_details' %}
                <div class="mb-3">
                  <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                  {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- 1a. Disability -->
            <div class="form-check mb-2">
              {{ student_form.has_disability|add_class:"form-check-input" }}
              <label class="form-check-label" for="{{ student_form.has_disability.id_for_label }}">I have a disability</label>
            </div>
            <div id="disability_details" class="mb-3" style="display: {% if student_form.instance.has_disability %}block{% else %}none{% endif %};">
              {{ student_form.disability_details|add_class:"form-control" }}
              {% if student_form.disability_details.errors %}<div class="text-danger small">{{ student_form.disability_details.errors.0 }}</div>{% endif %}
            </div>

            <!-- 1b. Previous Bursary -->
            <div class="form-check mb-2">
              {{ student_form.previous_bursary|add_class:"form-check-input" }}
              <label class="form-check-label" for="{{ student_form.previous_bursary.id_for_label }}">I have received a bursary before</label>
            </div>
            <div id="previous_bursary_details" class="mb-3" style="display: {% if student_form.instance.previous_bursary %}block{% else %}none{% endif %};">
              {{ student_form.previous_bursary_details|add_class:"form-control" }}
              {% if student_form.previous_bursary_details.errors %}<div class="text-danger small">{{ student_form.previous_bursary_details.errors.0 }}</div>{% endif %}
            </div>

            <!-- 2. Guardian Info -->
            <h4 class="mt-4">2. Parent/Guardian Information</h4>
            {% for field in guardian_form %}
              <div class="mb-3">
                <label class="form-label">{{ field.label }}</label>
                {{ field|add_class:"form-control" }}
                {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
              </div>
            {% endfor %}

            <!-- 3. Application Info -->
            <h4 class="mt-4">3. Application Details</h4>
            <div class="mb-3">
              <label class="form-label">Constituency</label>
              <input type="text" class="form-control" value="{{ student_form.instance.constituency.name }}" readonly>
            </div>
            {% for field in application_form %}
              {% if field.name != 'constituency' %}
                <div class="mb-3">
                  <label class="form-label">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- 4. Sibling Info -->
            <h4 class="mt-4">4. Siblings in School</h4>
            <button type="button" class="btn btn-outline-primary mb-3" id="add-sibling-btn">➕ Add Sibling</button>
            {{ sibling_formset.management_form }}
            <div id="siblings-container">
              {% for form in sibling_formset %}
                <div class="border p-3 mb-3 rounded shadow-sm bg-light sibling-item position-relative">
                  <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
                  {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                      <div class="mb-2">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                  {{ form.DELETE|add_class:"d-none" }}
                </div>
              {% endfor %}
            </div>

            <!-- 5. Supporting Documents -->
            <h4 class="mt-4">5. Supporting Documents</h4>
            <p>Please upload the following documents:</p>
            <ul>
              <li>Admission Letter</li>
              <li>School Fee Structure</li>
              <li>Copy of ID/Birth Certificate</li>
              <li>KCPE/KCSE/Previous Results</li>
              <li>Death Certificate (if orphan)</li>
              <li>Disability Certificate (if applicable)</li>
            </ul>

            {{ document_formset.management_form }}
            <div id="documents-container">
              {% for form in document_formset %}
                <div class="border p-3 mb-3 rounded shadow-sm bg-light form-item position-relative">
                  <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
                  {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                      <div class="mb-2">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                  {{ form.DELETE|add_class:"d-none" }}
                </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary mb-3" id="add-document-btn">➕ Add Another Document</button>

            <!-- Submit Button -->
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary px-5">Submit Application</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Hidden Templates for JS cloning -->
<div id="empty-sibling-form" class="d-none">
  <div class="border p-3 mb-3 rounded shadow-sm bg-light sibling-item position-relative">
    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
    __FORM__
  </div>
</div>

<div id="empty-document-form" class="d-none">
  <div class="border p-3 mb-3 rounded shadow-sm bg-light form-item position-relative">
    <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="markForDelete(this)"></button>
    __FORM__
  </div>
</div>

<!-- JS Section -->
<script>
  // Empty form templates from Django
  const sibling_formset_empty_form = `{{ sibling_formset.empty_form.as_p|escapejs }}`;
  const document_formset_empty_form = `{{ document_formset.empty_form.as_p|escapejs }}`;

  // Toggle disability details
  const disabilityCheckbox = document.getElementById('{{ student_form.has_disability.id_for_label }}');
  const disabilityDetails = document.getElementById('disability_details');
  if (disabilityCheckbox) {
    disabilityCheckbox.addEventListener('change', function() {
      disabilityDetails.style.display = this.checked ? 'block' : 'none';
    });
  }

  // Toggle previous bursary details
  const bursaryCheckbox = document.getElementById('{{ student_form.previous_bursary.id_for_label }}');
  const bursaryDetails = document.getElementById('previous_bursary_details');
  if (bursaryCheckbox) {
    bursaryCheckbox.addEventListener('change', function() {
      bursaryDetails.style.display = this.checked ? 'block' : 'none';
    });
  }

  // Mark for delete
  function markForDelete(button) {
    const form = button.closest('.form-item, .sibling-item');
    form.querySelector('input[type=checkbox][name$="-DELETE"]').checked = true;
    form.style.display = 'none';
  }

  // Add sibling
  document.getElementById('add-sibling-btn').addEventListener('click', function () {
    const totalForms = document.getElementById('id_siblings-TOTAL_FORMS'); 
    const newIdx = parseInt(totalForms.value);
    const newForm = sibling_formset_empty_form.replace(/__prefix__/g, newIdx);
    document.getElementById('siblings-container').insertAdjacentHTML('beforeend',
      `<div class="border p-3 mb-3 rounded shadow-sm bg-light sibling-item position-relative">
         <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                 aria-label="Remove" onclick="markForDelete(this)"></button>
         ${newForm}
       </div>`);
    totalForms.value = newIdx + 1;
  });

  // Add document
  document.getElementById('add-document-btn').addEventListener('click', function () {
    const totalForms = document.getElementById('id_documents-TOTAL_FORMS'); // ✅ correct prefix
    const newIdx = parseInt(totalForms.value);
    const newForm = document_formset_empty_form.replace(/__prefix__/g, newIdx);
    document.getElementById('documents-container').insertAdjacentHTML('beforeend',
      `<div class="border p-3 mb-3 rounded shadow-sm bg-light form-item position-relative">
         <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                 aria-label="Remove" onclick="markForDelete(this)"></button>
         ${newForm}
       </div>`);
    totalForms.value = newIdx + 1;
  });
</script>

{% if application_deadline %}
  <div class="deadline-ticker-wrapper mt-4">
    <div class="deadline-ticker">
      ⏳ Deadline: {{ application_deadline|date:"F j, Y" }} – Don’t wait until the last minute!
    </div>
  </div>
{% endif %}
{% endblock %}















